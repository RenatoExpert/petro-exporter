#!/bin/perl

use warnings;
use strict;

#	Nome da certificadora
my $empresa;
my $run_empresa		= 1;
#	Data do certificado
my $datacert; 
my $run_datacert	= 1;
#	Altura util
my $vendo_altura;
my $altura_util;
my $run_altura_util	= 1;
#	Contando aneis
my $segunda_aba		= 0;
my $aneis_counter	= 0;
my $missing		= 0;
my $comecou		= 0;
my $run_contando_aneis	= 1;
while(<>){
	if ($run_empresa) {
		if ($_ =~ m/Empresa:,/) {
			$empresa = $_;
			$empresa =~ s/Empresa:,//;
			$empresa =~ s/\n//;
			$run_empresa = 0;
		}
	}
	if ($run_datacert) {
		if ($_ =~ m/Certificado:,/) {
			$datacert = $_ ;
			$datacert =~ s/Certificado:,//;
			$datacert =~ s/\n//;
			$run_datacert = 0;
		}
	}
	if ($run_altura_util) {
		# Ele começa a olhar as alturas depois de encontrar a palavra Altura NA PRIMEIRA ABA!!
		if ($_ =~ m/Altura/) {	
			$vendo_altura = 1;
		} elsif ($vendo_altura) {
			# Sabemos que a sessão acaba quando aparece qualquer linha NAO começada com um numero
			if ($_ =~ m/^[0-9]/) {			
				$altura_util = $_;
			} else {
				my @firstfield = split /,/, $altura_util;
				$altura_util = $firstfield[0];
				$run_altura_util = 0;
			}
		}
	}
	if ($run_contando_aneis) {
		# Ele começa a olhar as alturas depois de encontrar a palavra Altura NA SEGUNDA ABA!!
		print $_;
		if ($_ =~ m/Faixas de Arqueação/) {	
			$segunda_aba = 1;
		} elsif ($comecou) {
			if ($_ =~ m/Faixa de/) {			
				$aneis_counter++;
				$missing = 0;
			} elsif ($_ =~ m/^[0-9]/) {
				$missing = 0;
			} elsif ($missing) {
				$run_contando_aneis = 0;
			} else {
				$missing++;
			}
		} elsif ($segunda_aba) {
			if ($_ =~ m/Faixa de/) {			
				$aneis_counter++;
				$comecou++;
			}
		}
	}
}

my $certimestamp;
my @listtemp = split /\//, $datacert;
$certimestamp = $listtemp[1];
if ($certimestamp =~ m/[0-9]{4}/) {
	#print("$certimestamp 4 vezes\n");
} else {
	$certimestamp = "20${certimestamp}";
}


#	Atribuindo anelid's

my $anelidfile = './idcount';
my $previousid = 1;
open (IC, '<', $anelidfile) or die $!;
while (<IC>) {
	if ($_ =~ m/[0-9]/) {
		if($_ > $previousid) {
			$previousid = $_;
		}
	}
}
close (IC);

$previousid++;
open (IW, '>', $anelidfile);
print IW "$previousid";
close(IW);

print("INSERT INTO arqueacoes (certarqueacao, datacertificado, alturautil, numeroaneis) VALUES ('${empresa}${datacert}', '${certimestamp}', '${altura_util}', '${aneis_counter}');\n");
